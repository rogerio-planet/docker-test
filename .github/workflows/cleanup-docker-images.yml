name: Schedule clean docker images

on:
  workflow_dispatch:
    inputs:
      number_of_days:
        description: 'Number of days to keep images'
        type: number
        required: false
        default: 15

  schedule:
    - cron: '0 2 * * *'

jobs:
  prune-ghcr:
    permissions:
      id-token: write
      contents: write
      packages: write
      
    runs-on: ubuntu-latest
    steps:
      - name: Prune old images except latest tags
        uses: vlaurin/action-ghcr-prune@v0.6.0
        with:
          user: rogerio-planet
          container: docker-test
          token: ${{ secrets.GITHUB_TOKEN }}
          dry-run: false
          prune-untagged: true
          keep-younger-than: ${{ github.event.inputs.number_of_days || 15 }}
          keep-tags-regexes: |
            ^(dev|integration)-latest$|^(dev|integration)-latest-linux-(amd64|arm64)$
          prune-tags-regexes: |
            ^(integration|dev)-((?!latest).)*$|^(integration|dev)-((?!latest).)*-linux-(amd64|arm64)$